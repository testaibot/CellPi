## Описание

Пайплайн для предобработки и базового анализа экспериментов одноклеточного RNAseq. 
Является сборкой лучших пакетов и программ для анализа scRNAseq.
Текущая версия пайплайна состоит из трёх основных частей, которые могут быть использованы как вместе
так и по отдельности

1) Препроцессинг сырых ридов. 
   * На вход: `GEO id` эксперимента, конфигурационный файл с описанием схемы баркодирования и числа клеток
   * Выход: рид-каунт матрицы, в которых при наличии UMI уже произведено удаление ПЦР-дубликатов
2) Предбработка рид-каунтов:
   * На вход: ридкаут-матрица 
   * Выход: нормализованные, почищенные от выбросов, лог-нормированные ридкаунты (условно «экспрессия»)
3) Кластеризация клеток и поиск маркеров
   * На вход: матрица экспрессии
   * Выход: `Seurat-объект` в котором содержится информация о финальных, неделимых более кластерах и 
таблица с перечислением найденных для каждого кластера маркеров с учётом информации о маркерах промежуточных кластеров. 
Таблица содержит стандартные скоры `adj_pval, fold_change` а так же информацию о `проценте клеток кластера` 
для которых этот ген является маркером 

## Ограничения
__В полностью автоматическом режиме `от SRR (1)` до маркеров пайплайн ограничен следующими протоколами:
`inDrop v1 & v2, inDrop v3` и совместимыми с ними на уровне схемы баркодирования `Cell-Seq, Cell-Seq2,...`__

__При анализе `от рид-каут матриц (2)` не поддерживается протокол Nanostring и сходные, дающие на выходе менее 500 генов__

__10X временно не поддерживается для автоматической загрузки__

__Смешивание различных организмов и типов аннотации в пределах одного датасета на текущий момент не поддерживается__

Оптимальные входные данные: матрица сырых, ненормированных ридкаунтов с числом клеток от 30 до 5000 и числом генов от 1000 до 12000. Строки - гены, столбцы - клетки

При подаче заранее нормализованных данных `TPM, RPKM, FPKMF` к ним автоматически будет применена функция [rel2abs из пакета monocle2](https://www.ncbi.nlm.nih.gov/pubmed/28114287).

Поддерживаемые имена генов: 
`Ensembl, Symbol(MGI, HGNC)`
```
ENSG00000111704, ENSG00000181449
ENSMUSG00000012396, ENSMUSG00000074637
Nanog, Sox2
```
Поддерживаемый формат имён клеток: <тип_клетки>.<номер_клетки> 
```
 d7.122 d0.484 d2.39  d2.213
 mef.1 mef.2 early2cell.1 zy.1
```

## 1. Препроцессинг ридов

В текущем состоянии поддерживаются протоколы:
    `inDrop v1 & v2, inDrop v3, 10x, iCLIP` и имеющие идентичную названным структуру баркодов. 
    По умолчанию поддерживаются `мышиный` и `человеческий` геномы. 
    При первом запуске будут автоматически подгружены `mm10` и `hg19` соответственно в зависимости от 
    выбранного в настройках организма. Так же будет загружена `gencode`-аннотация к ним.

### Тулчейн:
1) SRA tools prefetch – загрузка ридов по `SRR id` или id эксперимента, стандартно
2) fastq-dump – разбиение парных ридов, стандартно
3) droptag – демультиплексирование баркодов, тримминг низкокачественных ридов
4) STAR – выравнивание, стандартно. Так как `droptag` генерирует несколько SRR из исходного, запускаем выравнивание для каждого
5) dropest – подсчёт рид-каунтов, а так же удаление ПЦР-дубликатов с использованием `Unique molecular identifiers (UMI)` в случае их наличия в протоколе
6) Если при запуске препроцессинга установлен флаг `clean`, все промежуточные файлы удаляются `SRA, SRR, BAM`, оставляя только финальный файл с матрицей рид-каунтов

Полученная матица находится в папке 
```
$reads_path/$srr_id/cell.counts.matrices.rds
```

По умолчанию 
`reads_path=/home/SingleCellRNASeq/reads` 
`srr_id` берётся из имени входного SRR
```
  /home/SingleCellRNASeq/reads/SRR1784310/cell.counts.matrices.rds
  /home/SingleCellRNASeq/reads/SRR1784311/cell.counts.matrices.rds
```

## 2. Преобработка рид-каунтов

В текущем состоянии поддерживаются протоколы выход которых может быть представлен в виде матрицы с числом `клеток>50` и числом `генов>500`:
    Поддерживаются мышиный и человеческий геномы
    Формат идентификаторов генов автоматически будет конвертирован в требуемый промежуточным пакетам
    Выходной формат идентификаторов генов идентичен исходному
    По умолчанию выполняется фильтрация выбросов по размеру библиотеки, числу клеток и генов а так же проценту митохондриальных генов.
    При наличии спайк-ин генов, которые могут быть найдены регулярными выражениями `^ERCC-` либо `^ercc-`:  
```
 ERCC-2 ERCC-12 ercc-1 ercc2
```   
  они будут использованы автоматически. 
  
  __Ручной выбор генов для спайк-ин нормализации временно невозможен.__

По желанию фильтрация может быть проведена с учётом фазы клеточного цикла `cell_cycle = T`
 и/или процедурой коррекции дропаутов (попытка восстановления нулевых значений, 
 являющихся не реальными нулями, а погрешностью детектирования/выборки используемого метода) `impute = T`

### Используемые пакеты:
1) scater – фильтрация выбросов, основной дата-контейнер предобработки, стандартно
2) scran – [нормализация](https://genomebiology.biomedcentral.com/articles/10.1186/s13059-016-0947-7)
3) SAVER – [коррекция дропаутов](https://www.biorxiv.org/content/biorxiv/early/2017/05/17/138677.full.pdf), подтверждённо [один из лучших методов](https://www.biorxiv.org/content/early/2017/12/31/241190), используется совместно с M3Drop
4) M3Drop - поиск диффэкспрессирующихся генов для процедуры коррекции дропаутов, для снижения общего времени работы
5) monocle – [rel2abs ре-нормализация](https://www.ncbi.nlm.nih.gov/pubmed/28114287) пред-нормализованных либо сложно-нормализуемых ридкаунтов 
6) biomaRt – конвертация аннотаций
7) cyclone - [классификация по фазам клеточного цикла](https://www.sciencedirect.com/science/article/pii/S1046202315300098)

#### Основные шаги:
_Исполнение не прерывается при невозможности применения любого из шагов, расчёт продолжается с пропуском этапа вызвавшего ошибку_

0) Конвертирование аннотаций. Формат аннотации и организм определяется пересечением с 
   известной аннотацией как [Коэффициент Жаккара](https://en.wikipedia.org/wiki/Jaccard_index)
1) Базовый препроцессинг:
   * фильтрация выбросов более 3 [nmad](https://en.wikipedia.org/wiki/Median_absolute_deviation)
     * для размера библиотеки фильтр установлен только по `нижним` значениям
     * для числа клеток, экспрессирующих заданный ген так же `нижний` порог
     * митохондриальные гены фильтруются по `верхнему` пределу
     * спайк-ины фильтруются и по `обеим` границам
   * [нормализация](https://genomebiology.biomedcentral.com/articles/10.1186/s13059-016-0947-7) считается 
     отдельно для скайк-инов и основных генов, параметры нормализации подбираются автоматически
     В случае возникновения ошибки нормализации (например отрицательные size-факторы) производится 
     переход на linear inverse models вариант реализации 
     В случае сохранения ошибки, к исходной матрице применяется функция rel2abs и стандартная нормализация проводится заново
2) Декомпозиция по фазам клеточного цикла
   * Если выбран параметр `cell_cycle = T` генная аннотация конвертируется в формат Ensembl и отдаётся в cyclone для 
аннотации. После получения оценки фазы исходная матрица разбирается на три, соответствующие `G1, G2M и S`
фазам клеточного цикла. По умолчанию порог принадлежности к фазе установлен `>= 0.5` и не может быть изменён пользователем.
   * Каждая из полученных матриц пропускается через процедуру `Базового препроцессинга (1)` 
   * В случае `impute = F` производится обратное слияние матриц, иначе перед слиянием над каждой из матриц коррекция дропаутов
   производится отдельно
3) Коррекция дропаутов
   * В случае, если число генов в датасете превышает 2000 процедура коррекции проводится 
   только для дифф-экспрессирующихся генов. Гены ищутся в исходной матрице всеми алгоритмами, 
   доступными в M3Drop `holm, hochberg, hommel, bonferroni, BH, BY, fdr` с порогом 
   `fdr_threshold = 0.05` для миксимизации количества генов. Для датасета в 12000 генов такой 
   подход позволяет выбрать около 3000 генов.
   * Полученные гены разбиваются на две подвыборки чётные-нечётные и выбираются в качестве цели 
   для коррекции дропаутов. Такой подход позволит впоследствии дополнительно применить 
   на этих же данных [magic](https://www.biorxiv.org/content/early/2017/02/25/111591), не влияя на "маркерную" картину, 
   поскольку для анализа диффэкспрессии на следующих этапах используется [MAST](https://genomebiology.biomedcentral.com/articles/10.1186/s13059-015-0844-5), устойчиво работающий на zero-inflated данных.
   Из-за отличия в алгоритмах работы SAVER и Magic они способны более качественно фокусироваться на различных аспектах финальной картины. 
   [Saver способен качественно улучшать глобальную картину кластеризации, а MAGIC - детектирование маркеров](https://www.biorxiv.org/content/early/2017/12/31/241190). __Процедура экспериментальная, по умолчанию Magic отключён.__
   * После коррекции дропаутов процедура `Базового препроцессинга (1)` производится повторно
4) После выполнения предыдущих пунктов финальная матрица экспрессии переводится из `log2` в обычный вид `2^exprs_mtx-1`
и передаётся в процедуру кластеризации

## 3. Кластеризация клеток и поиск маркеров
