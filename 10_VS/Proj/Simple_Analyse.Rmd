

```{r}
#load to seurat
rec_final = cluster_recursive(curr_proc0, regress = F, regress_cc = NULL, do.magic = F)
rec_final0 = cluster_recursive(curr_proc1, regress = F, regress_cc = NULL, do.magic = F)
rec_final1 = cluster_recursive(curr_proc2, regress = F, regress_cc = NULL, do.magic = F)
rec_final2 = cluster_recursive(curr_proc3, regress = F, regress_cc = NULL, do.magic = F)
rec_final3 = cluster_recursive(curr_proc4, regress = F, regress_cc = NULL, do.magic = F)
rec_final4 = cluster_recursive(curr_proc5, regress = F, regress_cc = NULL, do.magic = F)

# rec_final = BuildSNN()
# rec_final_val = ValidateClusters(rec_final)



temp = seurat_analyse_mtx(curr_proc1, regress = F, regress_cc = NULL, do.magic = F)
table(get_orig_ident(temp), get_ident(temp))

temp1 = seurat_analyse_mtx(curr_proc1[,get_cell_names_by_ident(temp, "0")], regress = F, regress_cc = NULL, do.magic = F)
table(get_orig_ident(temp1), get_ident(temp1))

temp2 = seurat_analyse_mtx(curr_proc1[,get_cell_names_by_ident(temp1, "0")], regress = F, regress_cc = NULL, do.magic = F)
table(get_orig_ident(temp2), get_ident(temp2))

temp3 = seurat_analyse_mtx(curr_proc1[,get_cell_names_by_ident(temp2, "0")], regress = F, regress_cc = NULL, do.magic = F)
table(get_orig_ident(temp3), get_ident(temp3))

temp4 = seurat_analyse_mtx(curr_proc1[,get_cell_names_by_ident(temp3, "0")], regress = F, regress_cc = NULL, do.magic = F)
table(get_orig_ident(temp4), get_ident(temp4))

# temp5 = seurat_analyse_mtx(curr_proc1[,get_cell_names_by_ident(temp4, "1")], regress = F, regress_cc = NULL, do.magic = F)
# table(get_orig_ident(temp5), get_ident(temp5))
# # 
# for(k in seq(3, 20))
# {
#   temp1 = seurat_analyse_mtx(curr_proc0[,get_cell_names_by_ident(temp, "1")], regress = F, regress_cc = NULL, do.magic = F
#                              ,k.param_factor = k)
#   print(k)
#   try(print(table(get_orig_ident(temp1), get_ident(temp1))))
# }
# 
# temp3 = compute_tsne(temp3, do.loadings = T)
# 
# GetGeneLoadings(temp3, reduction.type = "tsne")
# 
# temp3@dr$tsne
#     temp3_temp = ValidateClusters(temp3, pc.use = 1:min(4, ), top.genes = 5)
# DimTopGenes(temp3, reduction.type = "tsne")
#     
#     for(pc in 2:ncol(temp3@dr$pca@cell.embeddings))
#     {
#       for(g_c in seq(2, 500, 2))
#       {
#         for(acc in seq(0.99, 0.9, -0.01))
#         {
#            s_out <- capture.output(ValidateClusters(temp3, pc.use = 1:pc, top.genes = g_c, acc.cutoff = 0.9, min.connectivity = 0))
#           s_out <- unlist(strsplit(s_out[which(grepl("clusters remaining", s_out))], c(" |\""), fixed = F))
#           s_out <- s_out[which(grepl("^\\d+$", s_out))][2]
#           
#           if(as.numeric(s_out)<4)
#           {
#             print("ch")
#             cat("s_out: ", s_out, " acc: ", acc, " pc: ", pc, " g_c:", g_c)
#             #break
#           }
#         }
#       }
#     }


# library(SC3)
#  #sce = readRDS(file = "F:\\bioinf\\Sk\\SingleCellRNASeq\\outer\\kolodziejczyk.rds")
#  sce = sce_norm(rel2abs(seur@raw.data)) #sce_norm(ceiling(merged_seur@raw.data))
#  sce = sc3(sce, ks = c(2,4,8,16,28), biology = F, gene_filter = F)
# 
# sc3_interactive(sce)
```

```{r}
curr = temp1
plot_seur(curr)

plot_seur(curr, "pca")

sort_diag(table(get_orig_ident(curr), get_ident(curr)))

plot_seur_3d(curr, radius = 1)
```





```{r}
curr = rec_final

```

```{r}
temp = sce$sc3_28_clusters


names(temp) = types2names(sce@colData$cell_type1)
tab = table(sce@colData$X, temp)
sort_diag(tab)
plot(sort(colMaxs(sort_diag(tab))))
sum(tab)


tab = table(get_orig_ident(curr), substr(sapply(get_ident(curr),toString), start = 1, stop = 7))
sort_diag(tab)

#mclust::adjustedRandIndex()

```


```{r}

cl_markers1 = FindAllMarkers(curr, test.use = "MAST", logfc.threshold = 0.05, return.thresh = 0.05, only.pos = F, min.pct = 0.7)

cl_markers1 = cl_markers1[order(sapply(cl_markers1[,"avg_logFC"],abs), decreasing = T),]

tab = cl_markers1[!grepl("^ERCC-", rownames(cl_markers1))&(cl_markers1$avg_logFC<(-0.5))&(cl_markers1$cluster=="2111"),]
table(cl_markers1$cluster)
rownames(tab)

#test GO, default params
#GO_enr(cl_markers)

for(i in unique(cl_markers1$cluster))
{
  shreh = 0.5
  mark_p = 
    #intersect(
    sort(rownames(cl_markers1)[which((cl_markers1$avg_logFC > (shreh)) & (cl_markers1$cluster==i))])
    #,markers)
  mark_n = 
    #intersect(
      sort(rownames(cl_markers1)[which((cl_markers1$avg_logFC < (-shreh)) & (cl_markers1$cluster==i))])
     # ,markers)
  if(length(mark_p)>0 && length(mark_n)>0)
    {
      print(list(i = i,
             mark_p = array(sapply(mark_p, function(item){return(unlist(strsplit(toString(item),".", fixed = T))[1])})),
        mark_n = array(sapply(mark_n, function(item){return(unlist(strsplit(toString(item),".", fixed = T))[1])}))))
    }
}


cl_markers1[c("Esrrb", "Jarid2", "Klf4",  "Nanog", "Pou5f1", "Sall4", "Sox2",  "Tbx3", "Tet1",  "Utf1" ,  "Wdr5" ,  "Zfp281"),]

```


```{r}
curr = merged_seur1

table(get_ident(curr), get_orig_ident(curr))
plot_seur(curr)
plot_seur(curr, method =  "pca")

plot_seur_3d(curr, radius = 0.3)


```


```{r}

par( mfrow = c(1,1))
for(gene in intersect(rownames(cl_markers$cluster.markers[1]$ident),  markers))
{
  FeaturePlot(object = curr, reduction.use = "tsne", features.plot = gene, cols.use = c("red", "green"))
}

```

```{r}
curr<-RunTSNE(curr)
par( mfrow = c(1,1))
for(gene in "Klf4")
{
  FeaturePlot(object = curr, reduction.use = "tsne", features.plot = gene, cols.use = c("red", "green"))
}

```

