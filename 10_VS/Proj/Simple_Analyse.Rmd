

```{r}

#load to seurat
rec_final = cluster_recursive(curr_proc, regress = F, regress_cc = NULL, do.magic = F, search_markers = F)
rec_final0 = cluster_recursive(curr_proc0, regress = F, regress_cc = NULL, do.magic = F, search_markers = F)
rec_final1 = cluster_recursive(curr_proc1, regress = F, regress_cc = NULL, do.magic = F, search_markers = F)
rec_final2 = cluster_recursive(curr_proc2, regress = F, regress_cc = NULL, do.magic = F, search_markers = F)
rec_final3 = cluster_recursive(curr_proc3, regress = F, regress_cc = NULL, do.magic = F, search_markers = F)
rec_final4 = cluster_recursive(curr_proc4, regress = F, regress_cc = NULL, do.magic = F, search_markers = F)
rec_final5 = cluster_recursive(curr_proc5, regress = F, regress_cc = NULL, do.magic = F, search_markers = F)



# rec_final = BuildSNN()
# rec_final_val = ValidateCluste

# temp = split_ident(CreateSeuratObject(raw.data = curr_proc5), regress = F, regress_cc = NULL, do.magic = F, search_markers = F)
# table(get_orig_ident(temp$obj), get_ident(temp$obj))
# 
# temp1 = split_ident(temp$obj, "s1", regress = F, regress_cc = NULL, do.magic = F, search_markers = F)
# table(get_orig_ident(temp1$obj), get_ident(temp1$obj))
# 
# temp2 = split_ident(temp1$obj, "s11", regress = F, regress_cc = NULL, do.magic = F, search_markers = F)
# table(get_orig_ident(temp2$obj), get_ident(temp2$obj))
# 
# temp3 = split_ident(temp2$obj, "s122", regress = F, regress_cc = NULL, do.magic = F, search_markers = F)
# table(get_orig_ident(temp3$obj), get_ident(temp3$obj))
# 
# temp4 = split_ident(temp3$obj, "s1212", regress = F, regress_cc = NULL, do.magic = F, search_markers = F)
# table(get_orig_ident(temp4$obj), get_ident(temp4$obj))
# 
# temp5 = split_ident(temp4$obj, "s12121", regress = F, regress_cc = NULL, do.magic = F, search_markers = F)
# table(get_orig_ident(temp5$obj), get_ident(temp5$obj))

# library(SC3)
#  #sce = readRDS(file = "F:\\bioinf\\Sk\\SingleCellRNASeq\\outer\\kolodziejczyk.rds")
#  sce = sce_norm(rel2abs(seur@raw.data)) #sce_norm(ceiling(merged_seur@raw.data))
#  sce = sc3(sce, ks = c(2,4,8,16,28), biology = F, gene_filter = F)
# 
# sc3_interactive(sce)

```

```{r}

curr = temp
plot_seur(curr$obj)

plot_seur(curr$obj, "pca")

sort_diag(table(get_orig_ident(curr$obj), get_ident(curr$obj)))

plot_seur_3d(curr$obj, radius = 1, lvls = NULL)


# markers_novo = curr$mark[which(curr$mark$p_val_adj<0.01),]
# markers_novo = markers_novo[order(markers_novo$avg_logFC, decreasing = T),]
# 
# rownames(markers_novo)
# 
# table(markers_novo$cluster)
```


```{r}
temp = sce$sc3_28_clusters


names(temp) = types2names(sce@colData$cell_type1)
tab = table(sce@colData$X, temp)
sort_diag(tab)
plot(sort(colMaxs(sort_diag(tab))))
sum(tab)


tab = table(get_orig_ident(curr$obj), substr(sapply(get_ident(curr$obj),toString), start = 1, stop = 3))
sort_diag(tab)

#mclust::adjustedRandIndex()

```


```{r}
cl_markers1 = markers_novo
cl_markers1 = cl_markers1[order(sapply(cl_markers1[,"avg_logFC"],abs), decreasing = T),]

table(cl_markers1$cluster)
rownames(tab)

#test GO, default params
#GO_enr(cl_markers)

for(i in unique(cl_markers1$cluster))
{
  shreh = 0.9
  mark_p = 
    #intersect(
    sort(rownames(cl_markers1)[which((cl_markers1$avg_logFC > (shreh)) & (cl_markers1$cluster==i))])
    #,markers)
  mark_n = 
    #intersect(
      sort(rownames(cl_markers1)[which((cl_markers1$avg_logFC < (-shreh)) & (cl_markers1$cluster==i))])
     # ,markers)
  if(length(mark_p)>0 && length(mark_n)>0)
    {
      print(list(i = i,
             mark_p = mark_p,# array(sapply(mark_p, function(item){return(unlist(strsplit(toString(item),".", fixed = T))[1])})),
        mark_n = mark_n))# array(sapply(mark_n, function(item){return(unlist(strsplit(toString(item),".", fixed = T))[1])}))))
    }
}


cl_markers_our = na.omit(cl_markers1[cl_markers1$gene %in% markers,])
cl_markers_our = cl_markers_our[order(sapply(cl_markers_our[,"avg_logFC"],abs), decreasing = T),]
cl_markers_our = cl_markers_our[order(cl_markers_our[,"gene"], decreasing = F),]

cl_markers_our

sort(unique(cl_markers1[cl_markers1$cluster%in%c("s1", "s2") & cl_markers1$pct.1>0.9 & cl_markers1$pct.2>0.9,]$gene))


unique(cl_markers1[cl_markers1$cluster%in%c("s1") & cl_markers1$pct.1==1 & cl_markers1$pct.2==1 & cl_markers1$avg_logFC<0,]$gene)
```


```{r}
curr = merged_seur1

table(get_ident(curr), get_orig_ident(curr))
plot_seur(curr)
plot_seur(curr, method =  "pca")

plot_seur_3d(curr, radius = 0.3)


```


```{r}

par( mfrow = c(1,1))
for(gene in intersect(rownames(cl_markers$cluster.markers[1]$ident),  markers))
{
  FeaturePlot(object = curr, reduction.use = "tsne", features.plot = gene, cols.use = c("red", "green"))
}

```

```{r}
curr<-RunTSNE(curr)
par( mfrow = c(1,1))
for(gene in "Klf4")
{
  FeaturePlot(object = curr, reduction.use = "tsne", features.plot = gene, cols.use = c("red", "green"))
}

```

