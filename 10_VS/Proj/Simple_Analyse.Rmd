

```{r}
#load to seurat
seur = split_ident(CreateSeuratObject(raw.data = curr_proc0), regress = F, regress_cc = NULL, do.magic = F)

# library(SC3)
#  #sce = readRDS(file = "F:\\bioinf\\Sk\\SingleCellRNASeq\\outer\\kolodziejczyk.rds")
#  sce = sce_norm(rel2abs(seur@raw.data)) #sce_norm(ceiling(merged_seur@raw.data))
#  sce = sc3(sce, ks = c(2,4,8,16,28), biology = F, gene_filter = F)
# 
# sc3_interactive(sce)
```

```{r}
curr = merged_seur0
plot_seur(curr)
plot_seur(curr, "pca")

sort_diag(table(get_ident(curr), get_orig_ident(curr)))
```



```{r}
object_list = split_all_ident(seur, do.magic = F)
merged_seur0 = seur_merge(object_list)
object_list1 = split_all_ident(merged_seur0, do.magic = F)
merged_seur1 = seur_merge(object_list1)

object_list2 = split_all_ident(merged_seur1, do.magic = T)
merged_seur2 = seur_merge(object_list2)

object_list3 = split_all_ident(merged_seur2, do.magic = T)
merged_seur3 = seur_merge(object_list3)
object_list4 = split_all_ident(merged_seur3, do.magic = T)
merged_seur4 = seur_merge(object_list4)

# object_list10 = split_all_ident(merged_seur3, regress = T, regress_cc = "cc_diff", do.magic = T)
# merged_seur10 = seur_merge(object_list10)


  # temp = FindClusters(object  =  seur, resolution = 1.7, algorithm  =  3, k.param  =  max(round(min(30, ncol(seur@raw.data)/3)),3), k.scale  =  max(round(min(25, ncol(seur@raw.data)/4)),2), modularity.fxn  =  1, print.output  =  F, save.SNN  =  T, force.recalc  =  T)


(table(sapply(get_ident(temp),toString)))
sort_diag(table(get_orig_ident(seur), get_ident(seur)))
```


```{r}
curr = merged_seur0

```

```{r}
temp = sce$sc3_28_clusters


names(temp) = types2names(sce@colData$cell_type1)
tab = table(sce@colData$X, temp)
sort_diag(tab)
plot(sort(colMaxs(sort_diag(tab))))
sum(tab)

curr = merged_seur1
tab = table(get_orig_ident(curr), substr(sapply(get_ident(curr),toString), start = 1, stop = 3))
sort_diag(tab)
plot(sort(colMaxs(sort_diag(tab))))
sum(tab)

#mclust::adjustedRandIndex()

```


```{r}

cl_markers1 = FindAllMarkers(curr, test.use = "MAST", logfc.threshold = 0.05, return.thresh = 0.05, only.pos = F, min.pct = 0.7)

cl_markers1 = cl_markers1[order(sapply(cl_markers1[,"avg_logFC"],abs), decreasing = T),]

tab = cl_markers1[!grepl("^ERCC-", rownames(cl_markers1))&(cl_markers1$avg_logFC<(-0.5))&(cl_markers1$cluster=="2111"),]
table(tab$cluster)
rownames(tab)

sort(rownames(cl_markers1))

#test GO, default params
#GO_enr(cl_markers)

for(i in unique(cl_markers1$cluster))
{
  shreh = 0
  mark_p = intersect(sort(rownames(cl_markers1)[which((cl_markers1$avg_logFC > (shreh)) & (cl_markers1$cluster==i))]),markers)
  mark_n = intersect(sort(rownames(cl_markers1)[which((cl_markers1$avg_logFC < (-shreh)) & (cl_markers1$cluster==i))]),markers)
  if(length(mark_p)>0 && length(mark_n)>0)
    {
      print(list(i = i,
             mark_p = mark_p,
        mark_n = mark_n))
    }
}


cl_markers1[c("Esrrb", "Jarid2", "Klf4",  "Nanog", "Pou5f1", "Sall4", "Sox2",  "Tbx3", "Tet1",  "Utf1" ,  "Wdr5" ,  "Zfp281"),]

```


```{r}
curr = merged_seur1

table(get_ident(curr), get_orig_ident(curr))
plot_seur(curr)
plot_seur(curr, method =  "pca")

plot_seur_3d(curr, radius = 0.3)


```


```{r}

par( mfrow = c(1,1))
for(gene in intersect(rownames(cl_markers$cluster.markers[1]$ident),  markers))
{
  FeaturePlot(object = curr, reduction.use = "tsne", features.plot = gene, cols.use = c("red", "green"))
}

```

```{r}
curr<-RunTSNE(curr)
par( mfrow = c(1,1))
for(gene in "Klf4")
{
  FeaturePlot(object = curr, reduction.use = "tsne", features.plot = gene, cols.use = c("red", "green"))
}

```

