

```{r}
#load to seurat
my_data_init <- CreateSeuratObject(raw.data = curr_proc4)
seur <- split_ident(my_data_init)

library(SC3)
sce <- readRDS(file = "F:\\bioinf\\Sk\\SingleCellRNASeq\\outer\\kolodziejczyk.rds")
sce <- sc3(sce, ks = c(16), biology = F, gene_filter = T)

#sc3_interactive(sce)
```

```{r}
object_list <- split_all_ident(seur, do.magic = F)
merged_seur <- seur_merge(object_list)
object_list1 <- split_all_ident(merged_seur, do.magic = F)
merged_seur1 <- seur_merge(object_list1)

object_list2 <- split_all_ident(merged_seur1, do.magic = F)
merged_seur2 <- seur_merge(object_list2)

object_list3 <- split_all_ident(merged_seur2, do.magic = F)
merged_seur3 <- seur_merge(object_list3)
object_list4 <- split_all_ident(merged_seur3, do.magic = F)
merged_seur4 <- seur_merge(object_list4)


table(sapply(get_ident(merged_seur3),toString))

object_list3
```


```{r}

sort_diag(table(get_orig_ident(merged_seur3), get_ident(merged_seur3)))

#go to prev chunk
#curr <- seur_1

```

```{r}

temp1 <- get_orig_ident(curr)
names(temp1) <- sapply(names(get_ident(curr)), function(item){return(paste(unlist(strsplit(item, ".", fixed = TRUE))[c(1,1)], collapse ="."))})

```

```{r}
temp <- sce$sc3_16_clusters
names(temp) <- types2names(sce@colData$cell_type1)
tab <- table(sce@colData$cell_type1, temp)
sort_diag(tab)
plot(sort(colMaxs(sort_diag(tab))))
sum(tab)

curr <- merged_seur2
tab <- table(get_orig_ident(curr), substr(sapply(get_ident(curr),toString), start = 1, stop = 4))
sort_diag(tab)
plot(sort(colMaxs(sort_diag(tab))))
sum(tab)

#mclust::adjustedRandIndex()

```


```{r}
curr <- merged_seur_sub


  
#cl_markers <- find_markers(curr, test.use = "MAST", logfc.threshold = 0.2, only.pos = F, min.pct = 0.7)

cl_markers1 <- FindAllMarkers(curr, test.use = "MAST", logfc.threshold = 0.2, only.pos = F, min.pct = 0.7)

cl_markers1 <- cl_markers1[order(sapply(cl_markers1[,"avg_logFC"],abs), decreasing = T),]
cl_markers1_p <- cl_markers1[,]
tab <- cl_markers1[!grepl("^ERCC-", rownames(cl_markers1))&(cl_markers1$avg_logFC<(-0.5))&(cl_markers1$cluster=="2111"),]
table(tab$cluster)
rownames(tab)

unique(cl_markers1$cluster)

#test GO, default params
#GO_enr(cl_markers)



sort(rownames(cl_markers$cluster.markers[4]$ident)[which(cl_markers$cluster.markers[4]$ident$avg_logFC < (0))])




```


```{r}
curr <- merged_seur1

table(get_ident(curr), get_orig_ident(curr))
plot_seur(curr)
plot_seur(curr, method =  "pca")

plot_seur_3d(curr, radius = 0.3)


```


```{r}

par( mfrow = c(1,1))
for(gene in intersect(rownames(cl_markers$cluster.markers[1]$ident),  markers))
{
  FeaturePlot(object = curr, reduction.use = "tsne", features.plot = gene, cols.use = c("red", "green"))
}

```

```{r}

par( mfrow = c(1,1))
for(gene in "POS_B")
{
  FeaturePlot(object = curr, reduction.use = "tsne", features.plot = gene, cols.use = c("red", "green"))
}

```

